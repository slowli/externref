<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Low-cost reference type shims for WASM modules."><title>externref - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="externref" data-themes="" data-resource-suffix="" data-rustdoc-version="1.81.0-nightly (ed7e35f34 2024-07-06)" data-channel="nightly" data-search-js="search-d234aafac6c221dd.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../externref/index.html">externref</a><span class="version">0.3.0-beta.1</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#reexports">Re-exports</a></li><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#attributes">Attribute Macros</a></li></ul></section></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">externref</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../src/externref/lib.rs.html#1-400">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Low-cost <a href="https://webassembly.github.io/spec/core/syntax/types.html#reference-types">reference type</a> shims for WASM modules.</p>
<p>Reference type (aka <code>externref</code> or <code>anyref</code>) is an opaque reference made available to
a WASM module by the host environment. Such references cannot be forged in the WASM code
and can be associated with arbitrary host data, thus making them a good alternative to
ad-hoc handles (e.g., numeric ones). References cannot be stored in WASM linear memory;
they are confined to the stack and tables with <code>externref</code> elements.</p>
<p>Rust does not support reference types natively; there is no way to produce an import / export
that has <code>externref</code> as an argument or a return type. <a href="https://crates.io/crates/wasm-bindgen"><code>wasm-bindgen</code></a> patches WASM if
<code>externref</code>s are enabled. This library strives to accomplish the same goal for generic
low-level WASM ABIs (<code>wasm-bindgen</code> is specialized for browser hosts).</p>
<h2 id="externref-use-cases"><a class="doc-anchor" href="#externref-use-cases">§</a><code>externref</code> use cases</h2>
<p>Since <code>externref</code>s are completely opaque from the module perspective, the only way to use
them is to send an <code>externref</code> back to the host as an argument of an imported function.
(Depending on the function semantics, the call may or may not consume the <code>externref</code>
and may or may not modify the underlying data; this is not reflected
by the WASM function signature.) An <code>externref</code> cannot be dereferenced by the module,
thus, the module cannot directly access or modify the data behind the reference. Indeed,
the module cannot even be sure which kind of data is being referenced.</p>
<p>It may seem that this limits <code>externref</code> utility significantly,
but <code>externref</code>s can still be useful, e.g. to model <a href="https://en.wikipedia.org/wiki/Capability-based_security">capability-based security</a> tokens
or resource handles in the host environment. Another potential use case is encapsulating
complex data that would be impractical to transfer across the WASM API boundary
(especially if the data shape may evolve over time), and/or if interactions with data
must be restricted from the module side.</p>
<h2 id="usage"><a class="doc-anchor" href="#usage">§</a>Usage</h2>
<ol>
<li>Use <a href="struct.Resource.html" title="struct externref::Resource"><code>Resource</code></a>s as arguments / return results for imported and/or exported functions
in a WASM module in place of <code>externref</code>s . Reference args (including mutable references)
and the <code>Option&lt;_&gt;</code> wrapper are supported as well.</li>
<li>Add the <code>#[externref]</code> proc macro on the imported / exported functions.</li>
<li>Post-process the generated WASM module with the <a href="processor/index.html" title="mod externref::processor"><code>processor</code></a>.</li>
</ol>
<p><code>Resource</code>s support primitive downcasting and upcasting with <code>Resource&lt;()&gt;</code> signalling
a generic resource. Downcasting is <em>unchecked</em>; it is up to the <code>Resource</code> users to
define a way to check the resource kind dynamically if necessary. One possible approach
for this is defining a WASM import <code>fn(&amp;Resource&lt;()&gt;) -&gt; Kind</code>, where <code>Kind</code> is the encoded
kind of the supplied resource, such as <code>i32</code>.</p>
<h2 id="how-it-works"><a class="doc-anchor" href="#how-it-works">§</a>How it works</h2>
<p>The <a href="attr.externref.html" title="attr externref::externref"><code>externref</code> macro</a> detects <code>Resource</code> args / return types
for imported and exported functions. All <code>Resource</code> args or return types are replaced
with <code>usize</code>s and a wrapper function is added that performs the necessary transform
from / to <code>usize</code>.
Additionally, a function signature describing where <code>Resource</code> args are located
is recorded in a WASM custom section.</p>
<p>To handle <code>usize</code> (~<code>i32</code> in WASM) &lt;-&gt; <code>externref</code> conversions, managing resources is performed
using 3 function imports from a surrogate module:</p>
<ul>
<li>Creating a <code>Resource</code> (“real” signature <code>fn(externref) -&gt; usize</code>) stores a reference
into an <code>externref</code> table and returns the table index. The index is what is actually
stored within the <code>Resource</code>, meaning that <code>Resource</code>s can be easily placed on heap.</li>
<li>Getting a reference from a <code>Resource</code> (“real” signature <code>fn(usize) -&gt; externref</code>)
is an indexing operation for the <code>externref</code> table.</li>
<li><a href="struct.Resource.html#method.drop" title="method externref::Resource::drop"><code>Resource::drop()</code></a> (“real” signature <code>fn(usize)</code>) removes the reference from the table.</li>
</ul>
<p>Real <code>externref</code>s are patched back to the imported / exported functions
by the WASM module post-processor:</p>
<ul>
<li>Imports from a surrogate module referenced by <code>Resource</code> methods are replaced
with local WASM functions. Functions for getting an <code>externref</code> from the table
and dropping an <code>externref</code> are more or less trivial. Storing an <code>externref</code> is less so;
we don’t want to excessively grow the <code>externref</code>s table, thus we search for null refs
among its existing elements first, and only grow the table if all existing table elements are
occupied.</li>
<li>Patching changes function types, and as a result types of some locals.
This is OK because the post-processor also changes the signatures of affected
imported / exported functions. The success relies on the fact that
a reference is only stored <em>immediately</em> after receiving it from the host;
likewise, a reference is only obtained <em>immediately</em> before passing it to the host.
<code>Resource</code>s can be dropped anywhere, but the corresponding <code>externref</code> removal function
does not need its type changed.</li>
</ul>
<h3 id="limitations"><a class="doc-anchor" href="#limitations">§</a>Limitations</h3>
<p>With debug info enabled, surrogate <code>usize</code>s may be spilled onto the shadow stack (part
of the WASM linear memory used by <code>rustc</code> / LLVM when the main WASM stack is insufficient).
This makes replacing these surrogates with <code>externref</code>s much harder (essentially, it’d require symbolic execution
of the affected function to find out which locals should be replaced with <code>externref</code>s). This behavior should be detected
by the <a href="processor/index.html" title="mod externref::processor">processor</a>, leading to “incorrectly placed externref guard” errors. Currently,
the only workaround is to <a href="https://doc.rust-lang.org/cargo/reference/profiles.html#debug">set debug info level</a>
to <code>limited</code> or below for the compiled WASM module.</p>
<h2 id="crate-features"><a class="doc-anchor" href="#crate-features">§</a>Crate features</h2><h3 id="std"><a class="doc-anchor" href="#std">§</a><code>std</code></h3>
<p><em>(Off by default)</em></p>
<p>Enables <code>std</code>-specific features, like <a href="https://doc.rust-lang.org/nightly/core/error/trait.Error.html" title="trait core::error::Error"><code>Error</code></a> implementations for error types.</p>
<h3 id="processor"><a class="doc-anchor" href="#processor">§</a><code>processor</code></h3>
<p><em>(Off by default)</em></p>
<p>Enables WASM module processing via the <a href="processor/index.html" title="mod externref::processor"><code>processor</code></a> module. Requires the <code>std</code> feature.</p>
<h3 id="tracing"><a class="doc-anchor" href="#tracing">§</a><code>tracing</code></h3>
<p><em>(Off by default)</em></p>
<p>Enables tracing during <a href="processor/index.html" title="mod externref::processor">module processing</a> with the <a href="https://docs.rs/tracing/"><code>tracing</code></a> facade.
Tracing events / spans mostly use <code>INFO</code> and <code>DEBUG</code> levels.</p>
<h2 id="examples"><a class="doc-anchor" href="#examples">§</a>Examples</h2>
<p>Using the <code>#[externref]</code> macro and <code>Resource</code>s in WASM-targeting code:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>externref::{externref, Resource};

<span class="comment">// Two marker types for different resources.
</span><span class="kw">pub struct </span>Sender(());
<span class="kw">pub struct </span>Bytes(());

<span class="attr">#[externref]
#[link(wasm_import_module = <span class="string">"test"</span>)]
</span><span class="kw">extern </span><span class="string">"C" </span>{
    <span class="comment">// This import will have signature `(externref, i32, i32) -&gt; externref`
    // on host.
    </span><span class="kw">fn </span>send_message(
        sender: <span class="kw-2">&amp;</span>Resource&lt;Sender&gt;,
        message_ptr: <span class="kw-2">*const </span>u8,
        message_len: usize,
    ) -&gt; Resource&lt;Bytes&gt;;

    <span class="comment">// `Option`s are used to deal with null references. This function will have
    // `(externref) -&gt; i32` signature.
    </span><span class="kw">fn </span>message_len(bytes: <span class="prelude-ty">Option</span>&lt;<span class="kw-2">&amp;</span>Resource&lt;Bytes&gt;&gt;) -&gt; usize;
    <span class="comment">// This one has `() -&gt; externref` signature.
    </span><span class="kw">fn </span>last_sender() -&gt; <span class="prelude-ty">Option</span>&lt;Resource&lt;Sender&gt;&gt;;
}

<span class="comment">// This export will have signature `(externref)` on host.
</span><span class="attr">#[externref]
#[export_name = <span class="string">"test_export"</span>]
</span><span class="kw">pub extern </span><span class="string">"C" </span><span class="kw">fn </span>test_export(sender: Resource&lt;Sender&gt;) {
    <span class="kw">let </span>messages: Vec&lt;<span class="kw">_</span>&gt; = [<span class="string">"test"</span>, <span class="string">"42"</span>, <span class="string">"some other string"</span>]
        .into_iter()
        .map(|msg| {
            <span class="kw">unsafe </span>{ send_message(<span class="kw-2">&amp;</span>sender, msg.as_ptr(), msg.len()) }
        })
        .collect();
    <span class="comment">// ...
    // All 4 resources are dropped when exiting the function.
</span>}</code></pre></div>
</div></details><h2 id="reexports" class="section-header">Re-exports<a href="#reexports" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name" id="reexport.BitSliceBuilder"><code>pub use crate::signature::BitSliceBuilder;</code></div></li></ul><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="processor/index.html" title="mod externref::processor">processor</a><span class="stab portability" title="Available on crate feature `processor` only"><code>processor</code></span></div><div class="desc docblock-short">WASM module processor for <code>externref</code>s.</div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BitSlice.html" title="struct externref::BitSlice">BitSlice</a></div><div class="desc docblock-short">Slice of bits. This type is used to mark <a href="struct.Resource.html" title="struct externref::Resource"><code>Resource</code></a> args
in imported / exported functions.</div></li><li><div class="item-name"><a class="struct" href="struct.Function.html" title="struct externref::Function">Function</a></div><div class="desc docblock-short">Information about a function with <a href="struct.Resource.html" title="struct externref::Resource"><code>Resource</code></a> args or return type.</div></li><li><div class="item-name"><a class="struct" href="struct.ReadError.html" title="struct externref::ReadError">ReadError</a></div><div class="desc docblock-short">Errors that can occur when reading declarations of functions manipulating <a href="struct.Resource.html" title="struct externref::Resource"><code>Resource</code></a>s
from a WASM module.</div></li><li><div class="item-name"><a class="struct" href="struct.Resource.html" title="struct externref::Resource">Resource</a></div><div class="desc docblock-short">Host resource exposed to WASM.</div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.FunctionKind.html" title="enum externref::FunctionKind">FunctionKind</a></div><div class="desc docblock-short">Kind of a function with <a href="struct.Resource.html" title="struct externref::Resource"><code>Resource</code></a> args or return type.</div></li><li><div class="item-name"><a class="enum" href="enum.ReadErrorKind.html" title="enum externref::ReadErrorKind">ReadErrorKind</a></div><div class="desc docblock-short">Kind of a <a href="struct.ReadError.html" title="struct externref::ReadError"><code>ReadError</code></a>.</div></li></ul><h2 id="attributes" class="section-header">Attribute Macros<a href="#attributes" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="attr" href="attr.externref.html" title="attr externref::externref">externref</a><span class="stab portability" title="Available on crate feature `macro` only"><code>macro</code></span></div><div class="desc docblock-short">Prepares imported functions or an exported function with <code>Resource</code> args and/or return type.</div></li></ul></section></div></main></body></html>